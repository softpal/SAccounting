@model StratusAccounting.Models.Inovices_DTO
@{
    ViewBag.Title = "AddPurchaseInvoice";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}
@Scripts.Render("~/bundle/Script/Dashboard")
<link href="~/Scripts/plugins/bootstrap-fileupload/bootstrap-fileupload.css" rel="stylesheet" />
@using (Html.BeginForm(new { ReturnUrl = ViewBag.ReturnUrl }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)
    @Html.HiddenFor(model => model.PInvoice.BusinessID)
    @Html.HiddenFor(model => model.PInvoice.UserVendorId)
    <div class="page-content">
        <!-- BEGIN PAGE CONTAINER-->
        <div class="container-fluid">
            <!-- BEGIN PAGE HEADER-->
            <div class="row-fluid">
                <div class="span12">

                    <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                    <!--<h3 class="page-title">Preferences</h3>-->
                    <ul class="breadcrumb margin-top-20">
                        <li><i class="icon-home"></i><a href="index.html">Home</a> <i class="icon-angle-right"></i></li>
                        <li><a href="chart_of_accounts.html">Transactions</a></li>
                        <li><i class="icon-angle-right"></i><a href="invoice.html">Invoice</a> </li>
                        <li><i class="icon-angle-right"></i><a href="new_invoice.html">New Invoice / Edit Invoice</a> </li>
                    </ul>
                    <!-- END PAGE TITLE & BREADCRUMB-->
                </div>
            </div>
            <!-- END PAGE HEADER-->
            <!-- BEGIN PAGE CONTENT-->
            <div class="row-fluid">
                <div class="span12">
                    <!-- BEGIN SAMPLE FORM PORTLET-->
                    <div class="portlet box blue border-topf">
                        <div class="portlet-body flip-scroll">
                            <!-- BEGIN FORM-->
                            <form class="horizontal-form" action="#">
                                <h3 class="form-section matop">Invoices</h3>
                                <div class="row-fluid">
                                    <div class="span9  account-right1">
                                        <div class="row-fluid margin-bottom-20">
                                            <div class="span8">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="radio">
                                                            <div class="radio">
                                                                <span class="checked">
                                                                    <input type="radio" name="optionsRadios1" value="option1"></span>
                                                            </div>
                                                            Purchase Invoice
                                                        </label>
                                                        <label class="radio">
                                                            <div class="radio">
                                                                <span class="">
                                                                    <input type="radio" name="optionsRadios1" value="option2" checked=""></span>
                                                            </div>
                                                            Sales Invoice
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row-fluid">
                                            <div class="span4 ">
                                                <div class="control-group">
                                                    <label for="firstName" class="control-label">Invoice Title</label>
                                                    <div class="controls">
                                                        @Html.TextBoxFor(model => model.PInvoice.InvoiceTitle)
                                                        @Html.ValidationMessageFor(model => model.PInvoice.InvoiceTitle)
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span4 ">
                                                <div class="control-group">
                                                    <label for="firstName" class="control-label">Customer</label>
                                                    <div class="controls">
                                                            @*@Html.DropDownListFor(model => model.BusinessID, (SelectList)ViewBag.UserCustomers, "--select--", new { @id = "userCustomers", @class = "m-wrap span12 border-form-radius" })*@
                                                        <select class="span12 m-wrap border-form-radius" tabindex="1">
                                                            <option value="">Select</option>
                                                            <option value="">1 </option>
                                                            <option value="">2 </option>
                                                            <option value="">3 </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span4">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="control-label">Invoice #</label>
                                                        @Html.TextBoxFor(model => model.PInvoice.InvoiceNumber, new { @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.PInvoice.InvoiceNumber)
                                                        @*<input type="text" class="m-wrap span12 border-form-radius" readonly="" placeholder="Autopopulate Unquie#">*@
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row-fluid">
                                            <div class="span4">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="control-label">Purchase Order / Service order #</label>
                                                            @Html.DropDownListFor(model => model.PurchaseOrder.PONumber, (SelectList)ViewBag.POServiceNum, "--select--", new { @id = "purchaseProduct", @class = "m-wrap span12 border-form-radius" })
                                                        @Html.ValidationMessageFor(model => model.PurchaseOrder.PONumber)
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span4">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="control-label">Term</label>
                                                        @Html.DropDownListFor(model => model.PInvoice.Mst_InvoiceDueTerm.Term, (SelectList)ViewBag.InvoiceDueTerms,"--Select--",new{ @class="m-wrap span12 border-form-radius"})
                                                        @Html.ValidationMessageFor(model => model.PInvoice.Mst_InvoiceDueTerm.Term)
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="span4">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="control-label">Due Date</label>
                                                        @Html.TextBoxFor(model => model.PInvoice.DueDate, new { @id="txtDueDate"})
                                                        @Html.ValidationMessageFor(model => model.PInvoice.DueDate)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="purchaseDetails">
                                        <table class="table-bordered table-striped table-condensed cf margin-top-10 margin-bottom-10">
                                            <thead class="cf">
                                                <tr class="b1">
                                                    <th class="journal-padding-bootom">Product/Service/Project</th>
                                                    <th class="journal-padding-bootom">Description</th>
                                                    <th class="numeric journal-padding-bootom">Quantity</th>
                                                    <th class="numeric journal-padding-bootom">Amount</th>
                                                    <th class="numeric journal-padding-bootom">Tax</th>
                                                </tr>
                                            </thead>
                                            
                                            <tbody id="editorRows">

                                                @if (Model != null)
                                                {
                                                    foreach (StratusAccounting.Models.PurchaseOrderDetail purchaseOrderDetail in Model.PurchaseOrderDetail)
                                                    {
                                                        Html.RenderPartial("Transactions/PurchaseOrderDetails", purchaseOrderDetail);
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                            </div>
                                        @*<p><input id="btnAdd" type="button" value="@Model.PurchaseInvoiceDetails" /></p>
                                        <a href="#" onclick="addnew(this,1)" class="details-color pull-right">Add More</a>*@
                                        <a class="details-color pull-right" id="addItem">Add More</a>
                                        <div class="clearfix"></div>
                                        <div class="span2 pull-right">
                                            <p>Sub total<span class="pull-right">xxx.xx</span></p>
                                            <p>Tax1<span class="pull-right">xxx.xx</span></p>
                                            <p>Tax2<span class="pull-right">xxx.xx</span></p>
                                            <p>Tax3<span class="pull-right">xxx.xx</span></p>
                                            <p>Total<span class="pull-right">xxx.xx</span></p>
                                        </div>
                                        <div class="row-fluid">
                                            <div class="span12">
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <label class="control-label">Terms &amp; Conditions</label>
                                                        <textarea rows="3" class="m-wrap span12 border-form-radius"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row-fluid">
                                            <div class="span12">
                                                <div class="control-group">
                                                    <label class="control-label">Tag to</label>
                                                    <div class="controls">
                                                        <input id="tags_1" type="text" class="m-wra tags" value="Service, Project, Project1" style="display: none;"><div id="tags_1_tagsinput" class="tagsinput" style="width: auto; height: 100px;">
                                                            <span class="tag"><span>Service&nbsp;&nbsp;</span><a href="#" title="Removing tag">x</a></span><span class="tag"><span>Project&nbsp;&nbsp;</span><a href="#" title="Removing tag">x</a></span><span class="tag"><span>Project1&nbsp;&nbsp;</span><a href="#" title="Removing tag">x</a></span><div id="tags_1_addTag">
                                                                <input id="tags_1_tag" value="" data-default="add a tag" style="color: rgb(102, 102, 102); width: 80px;">
                                                            </div>
                                                            <div class="tags_clear"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span12 no-left-margin">
                                            <h3 class="form-section matop">Documents</h3>
                                            <div class="control-group">
                                                <div class="controls no-left-margin">
                                                    <div data-provides="fileupload" class="fileupload fileupload-new">
                                                        <div class="input-append">
                                                            <div class="uneditable-input"><i class="icon-file fileupload-exists"></i><span class="fileupload-preview"></span></div>
                                                            <span class="btn btn-file"><span class="fileupload-new">Upload</span> <span class="fileupload-exists">Change</span>
                                                                <input type="file" class="default">
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                <tbody>
                                                    <tr>
                                                        <td width="85%" valign="middle"><a href="#">one.pdf</a></td>
                                                        <td width="15%" align="center"><i class="icon-remove-circle f24"></i></td>
                                                    </tr>
                                                    <tr>
                                                        <td width="85%" valign="middle"><a href="#">excel.xls</a></td>
                                                        <td width="15%" align="center"><i class="icon-remove-circle f24"></i></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="clearfix"></div>
                                        <div class="form-actions ">
                                            <button class="btn black" type="submit"><i class="icon-remove"></i>Cancel</button>
                                            <button class="btn blue" type="button"><i class="icon-print"></i>Print</button>
                                            <button class="btn red" type="submit"><i class="icon-ok"></i>Save</button>
                                            <button class="btn green" type="button"><i class="icon-envelope"></i>Send Email</button>
                                        </div>
                                    </div>
                                    <div class="span3">
                                        <h4 class="border-btoom">Add to Invoice&nbsp;</h4>
                                        <button class="btn blue border-form-radius" type="button">Add All</button>
                                        <div class="span10 margin-top-10 invoice-border border-form-radius no-left-margin">

                                            <span class="font-size16">Estimate # 1006<br>
                                                <small>03/10/2014</small></span>
                                            <p class="font-size16">$10,000.00</p>
                                            <a class="btn mini green border-form-radius" href="#" style="margin-right: 5px;">Add</a>

                                            <a class="btn mini black border-form-radius" href="#">Open</a>
                                        </div>
                                        <div class="span10 margin-top-10 invoice-border border-form-radius no-left-margin">

                                            <span class="font-size16">Estimate # 1006<br>
                                                <small>03/10/2014</small></span>
                                            <p class="font-size16">$10,000.00</p>
                                            <a class="btn mini green border-form-radius" href="#" style="margin-right: 5px;">Add</a>
                                            <a class="btn mini black border-form-radius" href="#">Open</a>
                                        </div>
                                        <div class="span10 margin-top-10 invoice-border border-form-radius no-left-margin">
                                            <span class="font-size16">Estimate # 1006<br>
                                                <small>03/10/2014</small></span>
                                            <p class="font-size16">$10,000.00</p>
                                            <a class="btn mini green border-form-radius" href="#" style="margin-right: 5px;">Add</a>
                                            <a class="btn mini black border-form-radius" href="#">Open</a>
                                        </div>
                                        <div class="span10 margin-top-10 invoice-border border-form-radius no-left-margin">
                                            <span class="font-size16">Estimate # 1006<br>
                                                <small>03/10/2014</small></span>
                                            <p class="font-size16">$10,000.00</p>
                                            <a class="btn mini green border-form-radius" href="#" style="margin-right: 5px;">Add</a>
                                            <a class="btn mini black border-form-radius" href="#">Open</a>
                                        </div>
                                    </div>
                                </div>
                                <!-- END FORM-->
                                </form>
                        </div>
                    </div>
                    <!-- END SAMPLE FORM PORTLET-->
                </div>
            </div>

            <!-- END PAGE CONTENT-->
        </div>
        <!-- END PAGE CONTAINER-->
    </div>
}

<script type="text/javascript">

    $(document).ready(
    function () {
        $("#txtDueDate").datepicker();
    }
    );

    $("#addItem").click(function () {
        //debugger;
        $.ajax({
            url: "/Vendors/BlankEditorRow",
            cache: false,
            success: function (html) {
                //debugger;
                $("#editorRows").append(html);
            },
            error: function (error) {
                alert(error.message);
            }
        });
        return false;
    });

    var subtotal = 0;
    var totalTax = 0;
    var total = 0;
    function addSubTotal(field) {
        var i;
        var parent = field.parentNode.parentNode.parentNode.parentNode.innerHTML;
        $(parent).find('input').each(function (index, element) {
            if (element.id.indexOf("Description") >= 0) {
                i = parseInt(element.id.split('__Description')[0].split('_')[1]);
            }
        });

        var amount = parseInt($("#PurchaseOrderDetail_" + i + "__Amount").val());
        var quantity = parseInt($("#PurchaseOrderDetail_" + i + "__Quantity").val());
        if (!isNaN(amount) && !isNaN(quantity)) {
            subtotal += amount * quantity;
            $("#txtsubTotal").text(subtotal.toString());
        }
        calcTotalSums();
    }

    function addTax(field) {
        var i;
        var parent = field.parentNode.parentNode.parentNode.parentNode.innerHTML;
        $(parent).find('input').each(function (index, element) {
            if (element.id.indexOf("Description") >= 0) {
                i = parseInt(element.id.split('__Description')[0].split('_')[1]);
            }
        });
        var tax = parseInt($("#PurchaseOrderDetail_" + i + "__Tax").val());
        if (!isNaN(tax)) {
            totalTax += tax;
            $("#txttotalTax").text(totalTax.toString());
        }
        calcTotalSums();
    }

    function calcTotalSums() {
        total = totalTax + subtotal;
        $("#txtTotal").text(total.toString());
    }

    function SavePurchaseOrders() {
        debugger;

        var count;

        if ($("#purchaseDetails")[0].childNodes.length > 4)
            count = $("#purchaseDetails")[0].childNodes.length / 4;
        else
            count = 1;

        var pDetails = new Array(count);

        var pOrder = new Array(5);

        pOrder[0] = $("#txtPOTitle").val();
        pOrder[1] = $("#txtVendor").val();
        pOrder[2] = $("#txtPO").val();
        pOrder[3] = $("#txtExpiry").val();
        pOrder[4] = $("#txtCustomLabel").val();

        //txtPOTitle = $("#txtPOTitle").val();
        //txtVendor = $("#txtVendor").val();
        //txtPO = $("#txtPO").val();
        //txtExpiry = $("#txtExpiry").val();
        //txtCustomLabel = $("#txtCustomLabel").val();

        for (var i = 0; i < count; i++) {
            //debugger;
            pDetails[i] = new Array(5);
            pDetails[i][0] = $("#PurchaseOrderDetail_" + i + "__ItemId").val();
            pDetails[i][1] = $("#PurchaseOrderDetail_" + i + "__Description").val();
            pDetails[i][2] = $("#PurchaseOrderDetail_" + i + "__Quantity").val();
            pDetails[i][3] = $("#PurchaseOrderDetail_" + i + "__Amount").val();
            pDetails[i][4] = $("#PurchaseOrderDetail_" + i + "__Tax").val();
        }

        $.ajax({
            type: "POST",
            url: "/Vendors/SavePurchaseOrders",  //url: "/ChartofAccount/SavePurchaseOrders",
            dataType: "Json",
            contentType: 'application/json, charset=utf-8',
            cache: false,
            data: JSON.stringify({ pOrder: pOrder, pDetails: pDetails, aryFilePath: aryFilePath }),
            success: function (data) {
                if (data.length > 0) {
                    //debugger;
                    alert("Saved successfully");
                }
            },
            error: function (data) {
                //debugger;
                alert(data);
            }
        });
    }

    var aryFilePath = new Array();
    function AddFile() {
        //debugger;
        var fullPath = document.getElementById('upLoad').value;
        var filename;
        if (fullPath) {
            var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
            filename = fullPath.substring(startIndex);
            if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                filename = filename.substring(1);
            }
            var children = document.getElementById("tblFileName").innerHTML;
            children += '<tr><td width="85%" valign="middle"><a href="#">' + filename + '</a></td><td width="15%" align="center"><i class="icon-remove-circle f24"></i></td></tr>';
            document.getElementById("tblFileName").innerHTML = children;
            document.getElementById('upLoad').value = "";
            aryFilePath.push([fullPath]);
        }
    }

    function Removefile(element) {
        var fileName = element.parentNode.parentNode.parentNode.innerHTML.split('#\">')[1].split("</")[0];
        aryFilePath.splice($.inArray(fileName, aryFilePath), 1);
        document.getElementById("tblFileName").innerHTML = '';
        var children = '';
        for (var i = 0; i < aryFilePath.length; i++) {
            var fullPath = aryFilePath[i].toString();
            var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
            var filename = fullPath.substring(startIndex);
            if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                filename = filename.substring(1);
            }
            children += '<tr><td width="85%" valign="middle"><a href="#">' + filename + '</a></td><td width="15%" align="center"><i class="icon-remove-circle f24" onclick="Removefile(this);" style="cursor:pointer;"></i></td></tr>';
        }
        document.getElementById("tblFileName").innerHTML = children;
    }


    //$("#btnAdd").click(function () {
    //    var action = "/CompanyInfo/Add";
    //    $.ajax({
    //        url: action,
    //        cache: false,
    //        success: function (html) {
    //            $("#purchaseInvoicetbl").append(html);

    //        }
    //    });
    //    return false;
    //});


    //$(function () {
    //    $("#addAnother").click(function () {
    //        event.preventDefault();
    //        $.get(' ', function (template) {
    //            $("#tabletab").append(template);
    //        });
    //    });
    //});

    //function addnew(control, userId) {
    //    debugger;
    //    alert($(control).parent("tr").html());
    //}
</script>

